const { runIfMain, l } = require('./lib');

const input = `
......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^.^.^....................................................................
.............................................................................................................................................
...................................................................^.....^...................................................................
.............................................................................................................................................
..................................................................^.^...^.^..................................................................
.............................................................................................................................................
.................................................................^.^.^...^.^.................................................................
.............................................................................................................................................
................................................................^.^...^.^.^.^................................................................
.............................................................................................................................................
...............................................................^.^.^.......^.^...............................................................
.............................................................................................................................................
..............................................................^.^...^...^.^.^.^..............................................................
.............................................................................................................................................
.............................................................^.^.^.^.^.^.....^.^.............................................................
.............................................................................................................................................
............................................................^.......^.^.^...^...^............................................................
.............................................................................................................................................
...........................................................^...^.^.^...^...^...^.^...........................................................
.............................................................................................................................................
..........................................................^.^.^.....^.......^...^.^..........................................................
.............................................................................................................................................
.........................................................^...^.^.^.^.....^.....^.^.^.........................................................
.............................................................................................................................................
........................................................^.......^.^.^.^.^.^.^.....^.^........................................................
.............................................................................................................................................
.......................................................^.^.^.^.....^.^.^.^.^.^.^.^...^.......................................................
.............................................................................................................................................
......................................................^.........^.^...^.^.^.^...^.^.^.^......................................................
.............................................................................................................................................
.....................................................^...^.^.^.^...^.^.^.^...^.^.^.^.^.^.....................................................
.............................................................................................................................................
....................................................^.^...^...^.^.^.^.^...^.^.^...^...^.^....................................................
.............................................................................................................................................
...................................................^.^...^.^...^.^.^.^.^.^.^.....^.^.....^...................................................
.............................................................................................................................................
..................................................^.....^.^.....^.^.^.......^.....^...^.^.^..................................................
.............................................................................................................................................
.................................................^...^.^...^.^.^.^...^.^.^.^.^.^.^...^.....^.................................................
.............................................................................................................................................
................................................^...^.^.^.^.^.^.^.^.......^...^.^.^.^...^...^................................................
.............................................................................................................................................
...............................................^.^...^.^...^...^.^.^.^...^.^.....^...^.^.^.^.^...............................................
.............................................................................................................................................
..............................................^...^.^...^...^.^...^.^.^.^...^.^...^.^.^...^.^.^..............................................
.............................................................................................................................................
.............................................^.^.........^.^.....^.^.^.^.^...^...^...^.....^...^.............................................
.............................................................................................................................................
............................................^.^.^...^.^...^...^.^.^.^.^.^.....^.^.^.....^.^...^.^............................................
.............................................................................................................................................
...........................................^...^.^.^.^.^.^...^...^...^.^.......^...^.^.^.^.^.^.^.^...........................................
.............................................................................................................................................
..........................................^.......^.^.^.^.^...^.^.^.^...^.^...^.^.^.....^...^.^...^..........................................
.............................................................................................................................................
.........................................^...^.^...^...^...^.^...^.^.^.^.^...^.....^...^...^.^.^...^.........................................
.............................................................................................................................................
........................................^.^.^.^.^.....^.^.^.....^...^.^.^.^.^.^.^.^...^.^...^...^...^........................................
.............................................................................................................................................
.......................................^...^.^...^.^.^...^.^...^.........^...^.^.....^.^...^.^.^.^...^.......................................
.............................................................................................................................................
......................................^...^...^.....^...^.......^.^...^...^.....^...........^.^.^.^.^.^......................................
.............................................................................................................................................
.....................................^...^.^.^.^.^.^.....^.^.^.^.^.^.....^...^.^.^.^...^.....^.^.^...^.^.....................................
.............................................................................................................................................
....................................^...........^...^.......^.^.^.^.........^.^.^...^.....^.^.^.^.......^....................................
.............................................................................................................................................
...................................^.^.^...^.^.^.....^.....^.^.^.^.^.^.^...^.^.^.^.^...^.^...^.^.^.^...^.^...................................
.............................................................................................................................................
..................................^...^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^...^...^.^.^.^.^.^.^.^..................................
.............................................................................................................................................
.................................^...^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^...^.^.......^.^.................................
.............................................................................................................................................
................................^.^.^.^.^...^.^.......^.^.^.^.^.^.....^.^.^...^.......^...^...^.^.^.....^...^................................
.............................................................................................................................................
...............................^.....^.^.......^.^...^.^...^.^.^...^...^.^.^.........^.^.^.^.^.....^...^...^.^...............................
.............................................................................................................................................
..............................^.^.^...^.....^.^...^.^.^.^.^.^.^.^.........^.^...^...^...^.^.^...^...^.^.^.....^..............................
.............................................................................................................................................
.............................^.^.....^.......^.^.^.^.^.^...^.....^.^.^.^...^.^.^...^.^.^.^.^.^...^.^.^.^...^.^.^.............................
.............................................................................................................................................
............................^.......^...^.^.^.....^...^.^.^.^.^.^.^...^...^.......^.^...^.^.^.^.........^.^...^.^............................
.............................................................................................................................................
...........................^...^...^.^.^.^...^.^...^...^.^...^.^.^.^.^.^.....^...^.^.....^.^.^.^...^.........^...^...........................
.............................................................................................................................................
..........................^.^.^.^.^.^.....^...^...^.^.^.....^...^.^.^...^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.....^...^..........................
.............................................................................................................................................
.........................^.^.^.......^.^.^.....^.^.^.^...^.^.^...^...^...^.^...^.^.....^.^.^.........^.....^.^.^...^.........................
.............................................................................................................................................
........................^.^.^.....^.^...^.^.......^.^.^.....^.^.^.......^.^.....^.^.^.^.^.^.^...^.....^.^.^.^.^.^...^........................
.............................................................................................................................................
.......................^.^.^.....^.^.........^.^.........^...^...^.^.....^.^.^.^.....^...^.^.^.^.^.....^.^.^...^.....^.......................
.............................................................................................................................................
......................^...^.^.^.....^.^.^...^.^.^.^.^...^...^...^.^.^.^...^.^...^.^.^.^.^...^.^...^...^.^.....^...^...^......................
.............................................................................................................................................
.....................^...^.^.^.....^.^.^...^.^.^...^.^.^.....^...^.......^.^.^.^...^.^.^.^.^.^.^.^...^.^.....^.^.^.^...^.....................
.............................................................................................................................................
....................^...^.^.^.....^...^...^.^...^...^...^.....^.^...^...^...^.......^...^.^...^.^...^.......^.^.......^.^....................
.............................................................................................................................................
...................^.^.^.............^.^.^...^.^.^.....^...^...^.^...^.^.^.^.^.................^.^.^.^.^.^.^.^.^.^...^.^.^...................
.............................................................................................................................................
..................^.^.....^.^.^.....^.^...^.^...^.^.^.^.^.^...^.^.^.^.^.^...^...^.^.^.^.......^.^.^.^.^.^.^.^.^.....^.^.^.^..................
.............................................................................................................................................
.................^.....^...^.....^...^.^.^...^...^.^...^...^.^.^...^.^.^.^...^...^.^.^.^.^...^.^.....^...^.^...^.^.......^.^.................
.............................................................................................................................................
................^.^...^...^.^.^...^.^.^.^.^.^.....^...^.^...^.^...^...^.^.....^...^...^.^...^...^...^...^.^...^.^.^.....^...^................
.............................................................................................................................................
...............^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.....^.^.^.......^.....^.^.^.......^.....^.^...^.^...^...^.^.^.^.....^.^...............
.............................................................................................................................................
..............^.^.^...^.^.^.....^.^.^.......^...^.^...^.^.^...^.^.^.^.^.^.........^.^.^.^.^.^...^...^.^.......^...^.^.....^.^.^..............
.............................................................................................................................................
.............^...^.......^...^.^.^.^...^.^.......^.^.^.^.....^.^.^...^...^.....^.^...^.^...^.^...^.^.^.^...^.......^.^.....^.^.^.............
.............................................................................................................................................
............^.^.^...^...^...^.^.^...^.......^...^...^.....^.^.^...^...^.^...^.^.^.^...^.^...^.^.^...^.^.^...^.^.^.^.^.^.....^...^............
.............................................................................................................................................
...........^.^.^...^.......^.^.^.^.^.....^...^...^.^.^.^.....^...^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.....^.^.^.^.^.^.^.^.^.^.^.^.^...........
.............................................................................................................................................
..........^.^.....^.^...^.....^...^.^.^...^.^.^.^.^...^...^.^...^.^.^...^.......^.^.^.^.^.^.......^.....^...^...^.^.......^...^...^..........
.............................................................................................................................................
.........^.^.....^.^.^.^.^.^.^...^...^.....^.^.^.....^.^.^.^.^.^...^...^...^.^.^...^.^.^.^.....^...^.^.^...^.^...^.^.........^.^.^.^.........
.............................................................................................................................................
........^.^.^.^.^.....^.^...^.^.^...^.^.^.^.......^...^...^.....^.^.....^.^.^...^.^.^...^.^...^.^...^.^.....^...^.....^.^.^.^.^.^...^........
.............................................................................................................................................
.......^.....^...^...^.....^.^.....^...^.^.^...^.^.....^.^.^.^.^...^...^.^.^.^.....^.^.^.^.^.^.^.^...^.^.^...^.^...^.^...^...^...^.^.^.......
.............................................................................................................................................
......^...^...^.......^...^.^...^.^.^.......^.^.^.^.^.....^.^.....^...^.^.^.........^...^...^.^.^...^.^...^.^.^.^.^...^.^.^.^.^.^.....^......
.............................................................................................................................................
.....^...^.^.^...^...^.^.......^.^.^.^.^.^.....^...^...^.^.^.^.^.^.^.......^...^.^...^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.....^.....
.............................................................................................................................................
....^.........^.^.^...^.^...^.^.^.^...^.^.....^.^.^.^.....^.^.^.^.....^.^.^...^.....^.^.^...^.^.^.^.....^...^.......^.^...^.^.^...^.^...^....
.............................................................................................................................................
...^.......^...^.^.^.^...^.............^.^...^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^.....^...^.^.^.....^.^.^...^.^.^.^.^.........^.^.^.^.^.^.^...
.............................................................................................................................................
..^.^.^.^...^...^.^.^.^...^.^.......^...^.^.^.^.^.^.^.^.^...^.^...^.....^.^...^.^.........^.^...^.^.^.^.....^.^.^...^.....^.^.....^.^.^.^.^..
.............................................................................................................................................
.^...^.^.^.^...^.^.^.^.^.....^...^.....^.^.^...^...^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.........^.^.^.....^.^.^.^.^.^.^.^...^...^.^.^...^...^.
.............................................................................................................................................`;

function init(input) {
  // INIT
  const [startLine, ...lines] = input.split('\n').filter(Boolean);
  const startPos = startLine.split('').reduce((pos, char, i) => char === 'S' ? i : pos);
  const levels = lines.map(line => {
    const splitters = new Set();
    let isSet = false;

    for (let i = 0; i < line.length; i++) {
      if (line.charAt(i) === '^') {
        splitters.add(i);
        isSet = true;
      }
    }
    return isSet && splitters;
  }).filter(Boolean);

  return {
    startPos,
    levels
  };
}

function part1(input, liveRun) {
  const { startPos, levels } = init(input);

  // Start tachyons
  let beams = new Set([startPos]);
  let splitHits = 0;

  for (let splitters of levels) {
    let nextBeams = new Set();
    beams.keys().forEach(pos => {
      if (splitters.has(pos)) {
        splitHits += 1;
        nextBeams.add(pos - 1);
        nextBeams.add(pos + 1);
      } else {
        nextBeams.add(pos);
      }
    });
    beams = nextBeams;
  }

  return splitHits;
}

function part2(input, liveRun) {
  const { startPos, levels } = init(input);
  const lastLevel = levels.length - 1;
  const timelevels = [...Array(levels.length)].map(() => new Map());

  levels[lastLevel].keys().forEach(pos => {
    timelevels[lastLevel].set(pos, 2);
  });

  for (let level = lastLevel - 1; level >= 0; level--) {
    timelevels[level + 1].entries().forEach(([pos, count]) => {
      timelevels[level].set(pos, count);
    });
    levels[level].keys().forEach(pos => {
      let left = timelevels[level].get(pos - 1) || 1;
      let right = timelevels[level].get(pos + 1) || 1;
      timelevels[level].set(pos, left + right);
    });
  }

  return timelevels[0].get(startPos);
}

function part2_too_naive(input, liveRun) {
  // Would be interesting to understand HOW slow this is....
  const { startPos, levels } = init(input);
  const lastLevel = levels.length - 1;
  let timelines = 0;

  function beamLevel(pos, level) {
    const splitters = levels[level];

    if (level === lastLevel) {
      timelines += splitters.has(pos) ? 2 : 1;
      return
    }

    if (splitters.has(pos)) {
      beamLevel(pos - 1, level + 1);
      beamLevel(pos + 1, level + 1);
    } else {
      beamLevel(pos, level + 1);
    }
  }

  beamLevel(startPos, 0);

  return timelines;
}

part1.desc = '';
part1.tests = [{
  input: `
.......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
...............`,
  result: 21,
}];

part2.desc = '';
part2.tests = [40];

runIfMain(module, input, part1, part2);

module.exports = {
  input,
  part1,
  part2,
};
